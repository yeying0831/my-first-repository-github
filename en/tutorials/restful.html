<!DOCTYPE html>
<html lang="en">
<head>
  <title>Build RESTful API - Born to build better enterprise frameworks and apps</title>
  <meta charset="utf-8">
  <meta name="description" content="index.description">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="icon" href="/images/favicon.png" type="image/x-icon">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" href="/css/index.css">

</head>
<body>
  <div class="nav" >
  <header>
    <a href="/" class="nav-logo leftpadding" alt="egg"><img src="https://zos.alipayobjects.com/rmsportal/VTcUYAaoKqXyHJbLAPyF.svg"></a>
    <ul class="nav-item">
      <li>
        <form id="search-form">
          <input type="text" id="search-query" class="search-query st-default-search-input">
        </form>
      </li>
      <li><a href="intro/" alt="Guide">Guide</a></li><li><a href="/api/" alt="API">API</a></li><li><a href="tutorials/index.html" alt="Tutorials">Tutorials</a></li><li><a href="https://github.com/search?q=topic%3Aegg-plugin&type=Repositories" alt="Plugins">Plugins</a></li><li><a href="https://github.com/eggjs/egg/releases" alt="Release">Release</a></li>
      <!--
      <li class="translations">
        <a class="nav-link">Translations</a>
        <span class="arrow"></span>
        <ul class="dropdown-content">
          <li><a href="/">中文</a></li>
          <li><a href="/">English</a></li>
        </ul>
      </li>
      -->
      <li><iframe src="https://ghbtns.com/github-btn.html?user=eggjs&repo=egg&type=star&count=true" frameborder="0" scrolling="0" width="150px" height="20px"></iframe></li>
    </ul>
    <a id="mobileTrigger" href="#" class="mobile-trigger">
      <ul>
        <li></li>
        <li></li>
        <li></li>
      </ul>
    </a>
  </header>
</div>

  <div id="container" class="container">
    <div class="page-main">
  <article class="markdown-body">
    <h1>Build RESTful API</h1>
    <p>Web frameworks are widely used for providing interfaces to the client through Web services. Let's use an example <a href="https://cnodejs.org/" target="_blank" rel="external">CNode Club</a> to show how to build <a href="https://en.wikipedia.org/wiki/REST" target="_blank" rel="external">RESTful</a> API using Egg.</p>
<p>CNode currently use v1 interface is not fully consistent with the RESTful semantic. In the article, we will encapsulate a more RESTful semantic V2 API based on CNode V1 interface.</p>
<h2 id="response-formatting"><a class="markdown-anchor" href="#response-formatting">#</a> Response Formatting</h2>
<p>Designing a RESTful-style API, we will identify the status of response by the response status code, keeping the response body simply and only the interface data is returned.
A example of <code>topics</code> is shown below:</p>
<h3 id="get-topics-list"><a class="markdown-anchor" href="#get-topics-list">#</a> Get topics list</h3>
<ul>
<li><code>GET /api/v2/topics</code></li>
<li>status code: 200</li>
<li>response body:</li>
</ul>
<figure class="highlight json"><table><tr><td class="code"><pre><div class="line">[</div><div class="line">  &#123;</div><div class="line">    <span class="attr">"id"</span>: <span class="string">"57ea257b3670ca3f44c5beb6"</span>,</div><div class="line">    <span class="attr">"author_id"</span>: <span class="string">"541bf9b9ad60405c1f151a03"</span>,</div><div class="line">    <span class="attr">"tab"</span>: <span class="string">"share"</span>,</div><div class="line">    <span class="attr">"content"</span>: <span class="string">"content"</span>,</div><div class="line">    <span class="attr">"last_reply_at"</span>: <span class="string">"2017-01-11T13:32:25.089Z"</span>,</div><div class="line">    <span class="attr">"good"</span>: <span class="literal">false</span>,</div><div class="line">    <span class="attr">"top"</span>: <span class="literal">true</span>,</div><div class="line">    <span class="attr">"reply_count"</span>: <span class="number">155</span>,</div><div class="line">    <span class="attr">"visit_count"</span>: <span class="number">28176</span>,</div><div class="line">    <span class="attr">"create_at"</span>: <span class="string">"2016-09-27T07:53:31.872Z"</span>,</div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="attr">"id"</span>: <span class="string">"57ea257b3670ca3f44c5beb6"</span>,</div><div class="line">    <span class="attr">"author_id"</span>: <span class="string">"541bf9b9ad60405c1f151a03"</span>,</div><div class="line">    <span class="attr">"tab"</span>: <span class="string">"share"</span>,</div><div class="line">    <span class="attr">"content"</span>: <span class="string">"content"</span>,</div><div class="line">    <span class="attr">"title"</span>: <span class="string">"Finished Rewriting of Let's Learning Node.js Together"</span>,</div><div class="line">    <span class="attr">"last_reply_at"</span>: <span class="string">"2017-01-11T10:20:56.496Z"</span>,</div><div class="line">    <span class="attr">"good"</span>: <span class="literal">false</span>,</div><div class="line">    <span class="attr">"top"</span>: <span class="literal">true</span>,</div><div class="line">    <span class="attr">"reply_count"</span>: <span class="number">193</span>,</div><div class="line">    <span class="attr">"visit_count"</span>: <span class="number">47633</span>,</div><div class="line">  &#125;,</div><div class="line">]</div></pre></td></tr></table></figure>
<h3 id="retrieve-one-topic"><a class="markdown-anchor" href="#retrieve-one-topic">#</a> Retrieve one topic</h3>
<ul>
<li><code>GET /api/v2/topics/57ea257b3670ca3f44c5beb6</code></li>
<li>status code: 200</li>
<li>response body:</li>
</ul>
<figure class="highlight json"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"id"</span>: <span class="string">"57ea257b3670ca3f44c5beb6"</span>,</div><div class="line">  <span class="attr">"author_id"</span>: <span class="string">"541bf9b9ad60405c1f151a03"</span>,</div><div class="line">  <span class="attr">"tab"</span>: <span class="string">"share"</span>,</div><div class="line">  <span class="attr">"content"</span>: <span class="string">"content"</span>,</div><div class="line">  <span class="attr">"title"</span>: <span class="string">"Finished Rewriting of Let's Learning Node.js Together"</span>,</div><div class="line">  <span class="attr">"last_reply_at"</span>: <span class="string">"2017-01-11T10:20:56.496Z"</span>,</div><div class="line">  <span class="attr">"good"</span>: <span class="literal">false</span>,</div><div class="line">  <span class="attr">"top"</span>: <span class="literal">true</span>,</div><div class="line">  <span class="attr">"reply_count"</span>: <span class="number">193</span>,</div><div class="line">  <span class="attr">"visit_count"</span>: <span class="number">47633</span>,</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="create-topics"><a class="markdown-anchor" href="#create-topics">#</a> Create topics</h3>
<ul>
<li><code>POST /api/v2/topics</code></li>
<li>status code: 201</li>
<li>response body:</li>
</ul>
<figure class="highlight json"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"topic_id"</span>: <span class="string">"57ea257b3670ca3f44c5beb6"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="update-topics"><a class="markdown-anchor" href="#update-topics">#</a> Update topics</h3>
<ul>
<li><code>PUT /api/v2/topics/57ea257b3670ca3f44c5beb6</code></li>
<li>status code: 204</li>
<li>response body: null</li>
</ul>
<h3 id="error-handling"><a class="markdown-anchor" href="#error-handling">#</a> Error handling</h3>
<p>When an error is occurring, 4xx status code is returned if occurred by client-side request parameters and 5xx status code is returned if occurred by server-side logic processing. All error objects are used as the description for status exceptions.</p>
<p>For example, passing invalided parameters from the client may return a response with status code 422, the response body as shown below:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"error"</span>: <span class="string">"Validation Failed"</span>,</div><div class="line">  <span class="attr">"detail"</span>: [ &#123; <span class="attr">"message"</span>: <span class="string">"required"</span>, <span class="attr">"field"</span>: <span class="string">"title"</span>, <span class="attr">"code"</span>: <span class="string">"missing_field"</span> &#125; ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="getting-started"><a class="markdown-anchor" href="#getting-started">#</a> Getting Started</h2>
<p>After interface convention, we begin to create a RESTful API.</p>
<h3 id="application-initialization"><a class="markdown-anchor" href="#application-initialization">#</a> Application initialization</h3>
<p>Initializes the application using <a href="https://github.com/eggjs/egg-init" target="_blank" rel="external">egg-init</a> in the <a href="../intro/quickstart.html">quickstart</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">$ egg-init cnode-api --<span class="built_in">type</span>=empty</div><div class="line">$ <span class="built_in">cd</span> cnode-api</div><div class="line">$ npm i</div></pre></td></tr></table></figure>
<h3 id="enable-validate-plugin"><a class="markdown-anchor" href="#enable-validate-plugin">#</a> Enable validate plugin</h3>
<p><a href="https://github.com/eggjs/egg-validate" target="_blank" rel="external">egg-validate</a> is used to present the validate plugin.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// config/plugin.js</span></div><div class="line">exports.validate = &#123;</div><div class="line">  <span class="attr">enable</span>: <span class="literal">true</span>,</div><div class="line">  <span class="attr">package</span>: <span class="string">'egg-validate'</span>,</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="router-registry"><a class="markdown-anchor" href="#router-registry">#</a> Router registry</h3>
<p>First of all, we follower previous design to register <a href="../basics/router.html">router</a>. The framework provides a simply way to create a RESTful-style router and mapping the resources to the corresponding controllers.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// app/router.js</span></div><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</div><div class="line">  app.resources(<span class="string">'topics'</span>, <span class="string">'/api/v2/topics'</span>, <span class="string">'topics'</span>);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>Mapping the 'topics' resource's CRUD interfaces to the <code>app/controller/topics.js</code> using <code>app.resources</code></p>
<h3 id="developing-controller"><a class="markdown-anchor" href="#developing-controller">#</a> Developing controller</h3>
<p>In <a href="../basics/controller.html">controller</a>, we only need to implement the interface convention of <code>app.resources</code> <a href="../basics/router.html#RESTful-style-URL-definition">RESTful style URL definition</a>. For example, creating a 'topics' interface:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// app/controller/topics.js</span></div><div class="line"><span class="comment">// defining the rule of request parameters</span></div><div class="line"><span class="keyword">const</span> createRule = &#123;</div><div class="line">  <span class="attr">accesstoken</span>: <span class="string">'string'</span>,</div><div class="line">  <span class="attr">title</span>: <span class="string">'string'</span>,</div><div class="line">  <span class="attr">tab</span>: &#123; <span class="attr">type</span>: <span class="string">'enum'</span>, <span class="attr">values</span>: [ <span class="string">'ask'</span>, <span class="string">'share'</span>, <span class="string">'job'</span> ], <span class="attr">required</span>: <span class="literal">false</span> &#125;,</div><div class="line">  <span class="attr">content</span>: <span class="string">'string'</span>,</div><div class="line">&#125;;</div><div class="line">exports.create = <span class="function"><span class="keyword">function</span>* (<span class="params">ctx</span>) </span>&#123;</div><div class="line">  <span class="comment">// validate the `ctx.request.body` with the expected format</span></div><div class="line">  <span class="comment">// status = 422 exception will be thrown if not passing the parameter validation</span></div><div class="line">  ctx.validate(createRule);</div><div class="line">  <span class="comment">// call service to create a topic</span></div><div class="line">  <span class="keyword">const</span> id = <span class="keyword">yield</span> ctx.service.topics.create(ctx.request.body);</div><div class="line">  <span class="comment">// configure the response body and status code</span></div><div class="line">  ctx.body = &#123;</div><div class="line">    <span class="attr">topic_id</span>: id,</div><div class="line">  &#125;;</div><div class="line">  ctx.status = <span class="number">201</span>;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>As shown above, a controller mainly implements the following logic:</p>
<ol>
<li>call the validate function to validate the request parameters</li>
<li>create a topic by calling service encapsulates business logic using the validated parameters</li>
<li>configure the status code and context according to the interface convention</li>
</ol>
<h3 id="developing-service"><a class="markdown-anchor" href="#developing-service">#</a> Developing service</h3>
<p>We will more focus on writing effective business logic in <a href="../basics/service.html">service</a>.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// app/service/topics.js</span></div><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">TopicService</span> <span class="keyword">extends</span> <span class="title">app</span>.<span class="title">Service</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span>(ctx) &#123;</div><div class="line">      <span class="keyword">super</span>(ctx);</div><div class="line">      <span class="keyword">this</span>.root = <span class="string">'https://cnodejs.org/api/v1'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    * create(params) &#123;</div><div class="line">      <span class="comment">// call CNode V1 API</span></div><div class="line">      <span class="keyword">const</span> result = <span class="keyword">yield</span> <span class="keyword">this</span>.ctx.curl(<span class="string">`<span class="subst">$&#123;<span class="keyword">this</span>.root&#125;</span>/topics`</span>, &#123;</div><div class="line">        <span class="attr">method</span>: <span class="string">'post'</span>,</div><div class="line">        <span class="attr">data</span>: params,</div><div class="line">        <span class="attr">dataType</span>: <span class="string">'json'</span>,</div><div class="line">        <span class="attr">contentType</span>: <span class="string">'json'</span>,</div><div class="line">      &#125;);</div><div class="line">      <span class="comment">// check whether the call was successful, throws an exception if it fails</span></div><div class="line">      <span class="keyword">this</span>.checkSuccess(result);</div><div class="line">      <span class="comment">// return the id of topis</span></div><div class="line">      <span class="keyword">return</span> result.data.topic_id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Encapsulated a uniform check function, can be reused in query, create, update and such on in service</span></div><div class="line">    checkSuccess(result) &#123;</div><div class="line">      <span class="keyword">if</span> (result.status !== <span class="number">200</span>) &#123;</div><div class="line">        <span class="keyword">const</span> errorMsg = result.data &amp;&amp; result.data.error_msg ? result.data.error_msg : <span class="string">'unknown error'</span>;</div><div class="line">        <span class="keyword">this</span>.ctx.throw(result.status, errorMsg);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (!result.data.success) &#123;</div><div class="line">        <span class="comment">// remote response error</span></div><div class="line">        <span class="keyword">this</span>.ctx.throw(<span class="number">500</span>, <span class="string">'remote response error'</span>, &#123; <span class="attr">data</span>: result.data &#125;);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> TopicService;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>After developing the service of topic creation, an interface have been completed from top to bottom.</p>
<h3 id="unified-error-handling"><a class="markdown-anchor" href="#unified-error-handling">#</a> Unified error handling</h3>
<p>Normal business logic has been completed, but exceptions have not yet been processed. Controller and service may throw an exception as the previous coding, so it is recommended that throwing an exception to interrupt if passing invalided parameters from the client or calling the back-end service with exception.</p>
<ul>
<li>use controller <code>this.validate()</code> to validate the parameters, throw exception if it fails.</li>
<li>call service <code>this.ctx.curl()</code> to access CNode service, may throw server exception due to network problems.</li>
<li>an exception also will be thrown after service is getting the response of calling failure from CNode server.</li>
</ul>
<p>Default error handling is provided but might be inconsistent as the interface convention previously. We need to implement a unified error-handling middleware to handle the errors.</p>
<p>Create a file <code>error_handler.js</code> under <code>app/middleware</code> directory to create a new <a href="../basics/middleware.html">middleware</a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// app/middleware/error_handler.js</span></div><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>* (<span class="params">next</span>) </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">yield</span> next;</div><div class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</div><div class="line">      <span class="comment">// All exceptions will trigger an error event on the app and the error log will be recorded</span></div><div class="line">      <span class="keyword">this</span>.app.emit(<span class="string">'error'</span>, err, <span class="keyword">this</span>);</div><div class="line"></div><div class="line">      <span class="keyword">const</span> status = err.status || <span class="number">500</span>;</div><div class="line">      <span class="comment">// error 500 not returning to client when in the production environment because it may contain sensitive information</span></div><div class="line">      <span class="keyword">const</span> error = status === <span class="number">500</span> &amp;&amp; <span class="keyword">this</span>.app.config.env === <span class="string">'prod'</span></div><div class="line">        ? <span class="string">'Internal Server Error'</span></div><div class="line">        : err.message;</div><div class="line"></div><div class="line">      <span class="comment">// Reading from the properties of error object and set it to the response</span></div><div class="line">      <span class="keyword">this</span>.body = &#123; error &#125;;</div><div class="line">      <span class="keyword">if</span> (status === <span class="number">422</span>) &#123;</div><div class="line">        <span class="keyword">this</span>.body.detail = err.errors;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">this</span>.status = status;</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>We can catch all exceptions and follow the expected format to encapsulate the response through the middleware. It can be loaded into application using configuration file (<code>config/config.default.js</code>)</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// config/config.default.js</span></div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  <span class="comment">// load the errorHandler middleware</span></div><div class="line">  middleware: [ <span class="string">'errorHandler'</span> ],</div><div class="line">  <span class="comment">// only takes effect on URL prefix with '/api'</span></div><div class="line">  errorHandler: &#123;</div><div class="line">    <span class="attr">match</span>: <span class="string">'/api'</span>,</div><div class="line">  &#125;,</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="testing"><a class="markdown-anchor" href="#testing">#</a> Testing</h2>
<p>Completing the coding just the first step, furthermore we need to add <a href="../core/unittest.html">Unit Test</a> to the code.</p>
<h3 id="controller-test"><a class="markdown-anchor" href="#controller-test">#</a> controller test</h3>
<p>Let's start writing the unit test for the controller. We can simulate the implementation of the service layer in an appropriate way because the most important part is to test the logic as for controller. And mocking up the service layer according the convention of interface, so we can develop layered testing because the service layer itself can also covered by service unit test.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="keyword">const</span> mock = <span class="built_in">require</span>(<span class="string">'egg-mock'</span>);</div><div class="line"></div><div class="line">describe(<span class="string">'test/app/controller/topics.test.js'</span>, () =&gt; &#123;</div><div class="line">  <span class="keyword">let</span> app;</div><div class="line">  before(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    <span class="comment">// create an instance quickly using the egg-mock library</span></div><div class="line">    app = mock.app();</div><div class="line">    <span class="keyword">return</span> app.ready();</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  afterEach(mock.restore);</div><div class="line"></div><div class="line">  <span class="comment">// test the response of passing the error parameters</span></div><div class="line">  it(<span class="string">'should POST /api/v2/topics/ 422'</span>, <span class="function"><span class="keyword">function</span>* (<span class="params"></span>) </span>&#123;</div><div class="line">    app.mockCsrf();</div><div class="line">    <span class="keyword">yield</span> app.httpRequest()</div><div class="line">    .post(<span class="string">'/api/v2/topics'</span>)</div><div class="line">    .send(&#123;</div><div class="line">      <span class="attr">accesstoken</span>: <span class="string">'123'</span>,</div><div class="line">    &#125;)</div><div class="line">    .expect(<span class="number">422</span>)</div><div class="line">    .expect(&#123;</div><div class="line">      <span class="attr">error</span>: <span class="string">'Validation Failed'</span>,</div><div class="line">      <span class="attr">detail</span>: [&#123; <span class="attr">message</span>: <span class="string">'required'</span>, <span class="attr">field</span>: <span class="string">'title'</span>, <span class="attr">code</span>: <span class="string">'missing_field'</span> &#125;, &#123; <span class="attr">message</span>: <span class="string">'required'</span>, <span class="attr">field</span>: <span class="string">'content'</span>, <span class="attr">code</span>: <span class="string">'missing_field'</span> &#125;],</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="comment">// mock up the service layer and test the response of normal request</span></div><div class="line">  it(<span class="string">'should POST /api/v2/topics/ 201'</span>, <span class="function"><span class="keyword">function</span>* (<span class="params"></span>) </span>&#123;</div><div class="line">    app.mockCsrf();</div><div class="line">    app.mockService(<span class="string">'topics'</span>, <span class="string">'create'</span>, <span class="number">123</span>);</div><div class="line">    <span class="keyword">yield</span> app.httpRequest()</div><div class="line">    .post(<span class="string">'/api/v2/topics'</span>)</div><div class="line">    .send(&#123;</div><div class="line">      <span class="attr">accesstoken</span>: <span class="string">'123'</span>,</div><div class="line">      <span class="attr">title</span>: <span class="string">'title'</span>,</div><div class="line">      <span class="attr">content</span>: <span class="string">'hello'</span>,</div><div class="line">    &#125;)</div><div class="line">    .expect(<span class="number">201</span>)</div><div class="line">    .expect(&#123;</div><div class="line">      <span class="attr">topic_id</span>: <span class="number">123</span>,</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>As the controller testing above, we create an application using <a href="https://github.com/eggjs/egg-mock" target="_blank" rel="external">egg-mock</a> and simulate the client to send request through <a href="https://github.com/visionmedia/supertest" target="_blank" rel="external">SuperTest</a>. In the testing, we also simulate the response from service layer to test the processing logic of controller layer</p>
<h3 id="service-testing"><a class="markdown-anchor" href="#service-testing">#</a> service testing</h3>
<p>Unit test of service layer may focus on the coding logic. <a href="https://github.com/eggjs/egg-mock" target="_blank" rel="external">egg-mock</a> provides a quick method to test the service by calling the test method in the service, and SuperTest to simulate the client request is no longer needed.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="keyword">const</span> assert = <span class="built_in">require</span>(<span class="string">'assert'</span>);</div><div class="line"><span class="keyword">const</span> mock = <span class="built_in">require</span>(<span class="string">'egg-mock'</span>);</div><div class="line"></div><div class="line">describe(<span class="string">'test/app/service/topics.test.js'</span>, () =&gt; &#123;</div><div class="line">  <span class="keyword">let</span> app;</div><div class="line">  <span class="keyword">let</span> ctx;</div><div class="line">  before(<span class="function"><span class="keyword">function</span>* (<span class="params"></span>) </span>&#123;</div><div class="line">    app = mock.app();</div><div class="line">    <span class="keyword">yield</span> app.ready();</div><div class="line">    <span class="comment">// create a global context object so that can call the service function on a ctx object</span></div><div class="line">    ctx = app.mockContext();</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  describe(<span class="string">'create()'</span>, () =&gt; &#123;</div><div class="line">    it(<span class="string">'should create failed by accesstoken error'</span>, <span class="function"><span class="keyword">function</span>* (<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// calling service method on ctx directly</span></div><div class="line">        <span class="keyword">yield</span> ctx.service.topics.create(&#123;</div><div class="line">          <span class="attr">accesstoken</span>: <span class="string">'hello'</span>,</div><div class="line">          <span class="attr">title</span>: <span class="string">'title'</span>,</div><div class="line">          <span class="attr">content</span>: <span class="string">'content'</span>,</div><div class="line">        &#125;);</div><div class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</div><div class="line">        assert(err.status === <span class="number">401</span>);</div><div class="line">        assert(err.message === <span class="string">'error accessToken'</span>);</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    it(<span class="string">'should create success'</span>, <span class="function"><span class="keyword">function</span>* (<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="comment">// not affect the normal operation of CNode by simulating the interface calling of CNode based on interface convention</span></div><div class="line">      <span class="comment">// app.mockHttpclient method can easily simulate the appliation's HTTP request</span></div><div class="line">      app.mockHttpclient(<span class="string">`<span class="subst">$&#123;ctx.service.topics.root&#125;</span>/topics`</span>, <span class="string">'POST'</span>, &#123;</div><div class="line">        <span class="attr">data</span>: &#123;</div><div class="line">          <span class="attr">success</span>: <span class="literal">true</span>,</div><div class="line">          <span class="attr">topic_id</span>: <span class="string">'5433d5e4e737cbe96dcef312'</span>,</div><div class="line">        &#125;,</div><div class="line">      &#125;);</div><div class="line">      <span class="keyword">const</span> id = <span class="keyword">yield</span> ctx.service.topics.create(&#123;</div><div class="line">        <span class="attr">accesstoken</span>: <span class="string">'hello'</span>,</div><div class="line">        <span class="attr">title</span>: <span class="string">'title'</span>,</div><div class="line">        <span class="attr">content</span>: <span class="string">'content'</span>,</div><div class="line">      &#125;);</div><div class="line">      assert(id === <span class="string">'5433d5e4e737cbe96dcef312'</span>);</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>In the testing of service layer above,  we create a context object using the <code>app.createContext()</code> which provided by egg-mock and call the service method on context object to test directly. It can use <code>app.mockHttpclient()</code> to simulate the response of calling HTTP request, which allows us to focus on the logic testing of service layer without the impact of environment.</p>
<hr>
<p>Details of code implementation and unit test are available in <a href="https://github.com/eggjs/examples/tree/master/cnode-api" target="_blank" rel="external">eggjs/examples/cnode-api</a></p>

  </article>
  <aside id="mobileAside" class="toc">
  <div class="mobile-menu">
    <ul><li><a href="intro/" alt="Guide">Guide</a></li><li><a href="/api/" alt="API">API</a></li><li><a href="tutorials/index.html" alt="Tutorials">Tutorials</a></li><li><a href="https://github.com/search?q=topic%3Aegg-plugin&type=Repositories" alt="Plugins">Plugins</a></li><li><a href="https://github.com/eggjs/egg/releases" alt="Release">Release</a></li></ul>
  </div>
  <dl><dt>Guide</dt><dd><ul><li><a href="/en/intro/index.html">What is Egg?</a></li><li><a href="/en/intro/egg-and-koa.html">Egg and Koa</a></li><li><a href="/en/intro/quickstart.html">Quick Start</a></li></ul></dd><dt>Basis Function</dt><dd><ul><li><a href="/en/basics/structure.html">Directory Structure</a></li><li><a href="/en/basics/objects.html">Built-in Objects</a></li><li><a href="/en/basics/env.html">Environment</a></li><li><a href="/en/basics/config.html">Configuration</a></li><li><a href="/en/basics/middleware.html">Middleware</a></li><li><a href="/en/basics/router.html">Router</a></li><li><a href="/en/basics/controller.html">Controller</a></li><li><a href="/en/basics/service.html">Service</a></li><li><a href="/en/basics/schedule.html">Schedule</a></li><li><a href="/en/basics/extend.html">Extend</a></li><li><a href="/en/basics/app-start.html">Custom Init</a></li></ul></dd><dt>Core</dt><dd><ul><li><a href="/en/core/development.html">Development</a></li><li><a href="/en/core/unittest.html">Unit Testing</a></li><li><a href="/en/core/deployment.html">应用部署</a></li><li><a href="/en/core/logger.html">Logger</a></li><li><a href="/en/core/httpclient.html">HttpClient</a></li><li><a href="/en/core/cookie-and-session.html">Cookie and Session</a></li><li><a href="/en/core/cluster-and-ipc.html">Cluster and IPC</a></li><li><a href="/en/core/view.html">View</a></li><li><a href="/en/core/error-handling.html">Error Handling</a></li><li><a href="/en/core/security.html">Security</a></li><li><a href="/en/core/i18n.html">i18n</a></li></ul></dd><dt>Tutorials</dt><dd><ul><li><a href="/en/tutorials/progressive.html">Progressive</a></li><li><a href="/en/tutorials/mysql.html">MySQL</a></li><li><a href="/en/tutorials/restful.html">RESTful API</a></li><li><a href="/en/tutorials/async-function.html">Async Function</a></li></ul></dd><dt>Advanced</dt><dd><ul><li><a href="/en/advanced/loader.html">Loader</a></li><li><a href="/en/advanced/plugin.html">Plugin</a></li><li><a href="/en/advanced/framework.html">Framework</a></li><li><a href="/en/advanced/cluster-client.html">Cluster Enhancement</a></li><li><a href="/en/advanced/view-plugin.html">View Plugin</a></li></ul></dd><dt>Community</dt><dd><ul><li><a href="/en/plugins/">内置插件列表</a></li><li><a href="/en/contributing.html">Contributing</a></li><li><a href="/en/resource.html">资源</a></li><li><a href="/en/faq.html">FAQ</a></li></ul></dd></dl>
</aside>
<script>
var mobileTrigger = document.getElementById('mobileTrigger');
var mobileAside = document.getElementById('mobileAside');
mobileTrigger.onclick = function(e) {
  if (mobileAside.className.indexOf('mobile-show') === -1) {
    mobileAside.className += ' mobile-show';
  } else {
    mobileAside.className = 'toc';
  }
};
</script>

</div>

  </div>
</body>
<script src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script>
<script>
docsearch({
  apiKey: '1561de31a86f79507ea00cdb54ce647c',
  indexName: 'eggjs',
  inputSelector: '#search-query',
});
</script>
<div class="cnzz">
<script src="https://s11.cnzz.com/z_stat.php?id=1261142226&web_id=1261142226" language="JavaScript"></script>
</div>

</html>
