<!DOCTYPE html>
<html lang="zh-cn">
<head><meta name="generator" content="Hexo 3.8.0">
  <title>TypeScript - 为企业级框架和应用而生</title>
  <meta charset="utf-8">
  <meta name="description" content="index.description">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="icon" href="/images/favicon.png" type="image/x-icon">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css">
<link rel="stylesheet" href="/css/index.css">

    <script>
    !function(t,e,a,r,c){t.TracertCmdCache=t.TracertCmdCache||[],t[c]=window[c]||
      {_isInit:!0,call:function(){t.TracertCmdCache.push(arguments)},
      start:function(t){this.call('start',t)}},t[c].l=new Date;
      var n=e.createElement(a),s=e.getElementsByTagName(a)[0];
      n.async=!0,n.src=r,s.parentNode.insertBefore(n,s)}
    (window,document,'script','https://tracert.alipay.com/tracert.js','Tracert');
      Tracert.start({
        plugins: [ 'BucName' ],
        spmAPos: 'a454',
        spmBPos: 'b4893',
      });
    </script>
  
<!-- Hotjar Tracking Code for https://eggjs.org -->
<script>
    (function(h,o,t,j,a,r){
        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
        h._hjSettings={hjid:1089836,hjsv:6};
        a=o.getElementsByTagName('head')[0];
        r=o.createElement('script');r.async=1;
        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
        a.appendChild(r);
    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
</script>

</head>
<body>
  <div class="nav">
  <header>
    <a href="/zh-cn/" class="nav-logo leftpadding" alt="egg"><img src="https://zos.alipayobjects.com/rmsportal/VTcUYAaoKqXyHJbLAPyF.svg"></a>
    <ul class="nav-item">
      <li>
        <form id="search-form">
          <input type="text" id="search-query" class="search-query st-default-search-input">
        </form>
      </li>
      <li><a href="/zh-cn/intro/" alt="指南">指南</a></li><li><a href="/api/" alt="API">API</a></li><li><a href="/zh-cn/tutorials/index.html" alt="教程">教程</a></li><li><a href="https://github.com/search?q=topic%3Aegg-plugin&type=Repositories" alt="插件">插件</a></li><li><a href="https://github.com/eggjs/egg/releases" alt="发布日志">发布日志</a></li>
      
      
        <li class="translations">
          <a class="nav-link">切换语言</a>
          <span class="arrow"></span><ul id="dropdownContent" class="dropdown-content"><li><a id="en" href="/en/tutorials/typescript.html">English</a></li><li><a id="zh-cn" href="/zh-cn/tutorials/typescript.html" style="color: #22ab28">中文</a></li></ul>
        </li>
      
      <li><iframe src="https://ghbtns.com/github-btn.html?user=eggjs&repo=egg&type=star&count=true" frameborder="0" scrolling="0" width="150px" height="20px"></iframe></li>
    </ul>
    <a id="mobileTrigger" href="#" class="mobile-trigger">
      <ul>
        <li></li>
        <li></li>
        <li></li>
      </ul>
    </a>
  </header>
</div>

  <div id="container" class="container">
    <div class="page-main">
  <aside id="mobileAside" class="aside">
  <div class="mobile-menu">
    <ul>
      <li><a href="/zh-cn/intro/" alt="指南">指南</a></li><li><a href="/api/" alt="API">API</a></li><li><a href="/zh-cn/tutorials/index.html" alt="教程">教程</a></li><li><a href="https://github.com/search?q=topic%3Aegg-plugin&type=Repositories" alt="插件">插件</a></li><li><a href="https://github.com/eggjs/egg/releases" alt="发布日志">发布日志</a></li>
      
      
        <li class="translations">
          <a class="nav-link">切换语言</a>
          <span class="arrow"></span><ul id="dropdownContent" class="dropdown-content"><li><a id="en" href="/en/tutorials/typescript.html">English</a></li><li><a id="zh-cn" href="/zh-cn/tutorials/typescript.html" style="color: #22ab28">中文</a></li></ul>
        </li>
      
    </ul>
  </div>
  <dl><dt id="title-Intro" style="cursor: pointer;" class="aside-title">新手指南<a id="collapse-icon-Intro" class="icon opend"></a></dt><dd id="panel-Intro"><ul><li><a href="/zh-cn/intro/index.html" class="menu-link">Egg.js 是什么？</a></li><li><a href="/zh-cn/intro/egg-and-koa.html" class="menu-link">Egg.js 和 Koa</a></li><li><a href="/zh-cn/intro/quickstart.html" class="menu-link">快速入门</a></li><li><a href="/zh-cn/tutorials/progressive.html" class="menu-link">渐进式开发</a></li><li><a href="/zh-cn/migration.html" class="menu-link">2.x 升级指南</a></li></ul></dd><dt id="title-Basics" style="cursor: pointer;" class="aside-title">基础功能<a id="collapse-icon-Basics" class="icon opend"></a></dt><dd id="panel-Basics"><ul><li><a href="/zh-cn/basics/structure.html" class="menu-link">目录结构</a></li><li><a href="/zh-cn/basics/objects.html" class="menu-link">内置对象</a></li><li><a href="/zh-cn/basics/env.html" class="menu-link">运行环境</a></li><li><a href="/zh-cn/basics/config.html" class="menu-link">配置</a></li><li><a href="/zh-cn/basics/middleware.html" class="menu-link">中间件</a></li><li><a href="/zh-cn/basics/router.html" class="menu-link">路由（Router）</a></li><li><a href="/zh-cn/basics/controller.html" class="menu-link">控制器（Controller）</a></li><li><a href="/zh-cn/basics/service.html" class="menu-link">服务（Service）</a></li><li><a href="/zh-cn/basics/plugin.html" class="menu-link">插件</a></li><li><a href="/zh-cn/basics/schedule.html" class="menu-link">定时任务</a></li><li><a href="/zh-cn/basics/extend.html" class="menu-link">框架扩展</a></li><li><a href="/zh-cn/basics/app-start.html" class="menu-link">启动自定义</a></li></ul></dd><dt id="title-Core" style="cursor: pointer;" class="aside-title">核心功能<a id="collapse-icon-Core" class="icon opend"></a></dt><dd id="panel-Core"><ul><li><a href="/zh-cn/core/development.html" class="menu-link">本地开发</a></li><li><a href="/zh-cn/core/unittest.html" class="menu-link">单元测试</a></li><li><a href="/zh-cn/core/deployment.html" class="menu-link">应用部署</a></li><li><a href="/zh-cn/core/logger.html" class="menu-link">日志</a></li><li><a href="/zh-cn/core/httpclient.html" class="menu-link">HttpClient</a></li><li><a href="/zh-cn/core/cookie-and-session.html" class="menu-link">Cookie and Session</a></li><li><a href="/zh-cn/core/cluster-and-ipc.html" class="menu-link">多进程模型和进程间通讯</a></li><li><a href="/zh-cn/core/view.html" class="menu-link">模板渲染</a></li><li><a href="/zh-cn/core/error-handling.html" class="menu-link">异常处理</a></li><li><a href="/zh-cn/core/security.html" class="menu-link">安全</a></li><li><a href="/zh-cn/core/i18n.html" class="menu-link">国际化</a></li></ul></dd><dt id="title-Tutorials" style="cursor: pointer;" class="aside-title">教程<a id="collapse-icon-Tutorials" class="icon opend"></a></dt><dd id="panel-Tutorials"><ul><li><a href="/zh-cn/tutorials/mysql.html" class="menu-link">MySQL</a></li><li><a href="/zh-cn/tutorials/sequelize.html" class="menu-link">Sequelize</a></li><li><a href="/zh-cn/tutorials/restful.html" class="menu-link">RESTful API</a></li><li><a href="/zh-cn/tutorials/passport.html" class="menu-link">Passport 鉴权</a></li><li><a href="/zh-cn/tutorials/socketio.html" class="menu-link">Socket.IO</a></li><li><a href="/zh-cn/tutorials/assets.html" class="menu-link">静态资源</a></li><li><a href="/zh-cn/tutorials/typescript.html" class="menu-link">TypeScript</a></li></ul></dd><dt id="title-Advanced" style="cursor: pointer;" class="aside-title">进阶<a id="collapse-icon-Advanced" class="icon opend"></a></dt><dd id="panel-Advanced"><ul><li><a href="/zh-cn/advanced/loader.html" class="menu-link">加载器（Loader）</a></li><li><a href="/zh-cn/advanced/plugin.html" class="menu-link">插件开发</a></li><li><a href="/zh-cn/advanced/framework.html" class="menu-link">框架开发</a></li><li><a href="/zh-cn/advanced/cluster-client.html" class="menu-link">多进程研发模式增强</a></li><li><a href="/zh-cn/advanced/view-plugin.html" class="menu-link">模板插件开发规范</a></li><li><a href="/zh-cn/style-guide.html" class="menu-link">代码风格指南</a></li></ul></dd><dt id="title-Community" style="cursor: pointer;" class="aside-title">社区<a id="collapse-icon-Community" class="icon opend"></a></dt><dd id="panel-Community"><ul><li><a href="/zh-cn/plugins/" class="menu-link">内置插件列表</a></li><li><a href="/zh-cn/contributing.html" class="menu-link">如何贡献</a></li><li><a href="/zh-cn/resource.html" class="menu-link">资源</a></li><li><a href="/zh-cn/faq.html" class="menu-link">常见问题</a></li></ul></dd></dl>
</aside>
<script>
var mobileTrigger = document.getElementById('mobileTrigger');
var mobileAside = document.getElementById('mobileAside');

var expandMenu = function(title) {
  // handle icon
  const collapseIcon = document.getElementById('collapse-icon-' + title);
  if (collapseIcon) {
    collapseIcon.className = 'icon opend';
  }
  // handle panelEle
  const panelEle = document.getElementById('panel-' + title);
  if (panelEle) {
    panelEle.className = '';
  }
}

var collapseMenu = function(title) {
  // handle icon
  const collapseIcon = document.getElementById('collapse-icon-' + title);
  if (collapseIcon) {
    collapseIcon.className = 'icon closed';
  }
  // handle panelEle
  const panelEle = document.getElementById('panel-' + title);
  if (panelEle) {
    panelEle.className = 'aside-panel-hidden';
  }
}

mobileAside.onclick = function(e) {
  const targetId = e.target.id;
  if (targetId && (targetId.indexOf('title-') > -1 || targetId.indexOf('collapse-icon-') > -1)) {
    const title = targetId.replace('title-', '').replace('collapse-icon-', '');
    try { 
      // the the browser may have no localStroage or JSON.parse may throw exception.
      const menuInfo = JSON.parse(window.localStorage.getItem('menuInfo'));
        
      // current menu status
      const curClosed = menuInfo[title] ? menuInfo[title].closed : false; // default false

      // change UI
      curClosed ? expandMenu(title) : collapseMenu(title);

      // save menuInfo to localStorage
      menuInfo[title] = { closed: !curClosed } // opposite
      window.localStorage.setItem('menuInfo', JSON.stringify(menuInfo));
    } catch (e) {}
  }
};

mobileTrigger.onclick = function(e) {
  e.preventDefault();
  if (mobileAside.className.indexOf('mobile-show') === -1) {
    mobileAside.className += ' mobile-show';
  } else {
    mobileAside.className = 'aside';
  }
};

(function() {
  // save data to localStorage because the page will refresh when user change the url.
  let menuInfo;
  try { 
    // the the browser may have no localStroage or JSON.parse may throw exception.
    menuInfo = JSON.parse(window.localStorage.getItem('menuInfo'));
    if (!menuInfo) {
      menuInfo = {};
      window.localStorage.setItem('menuInfo', JSON.stringify(menuInfo));
    }
  } catch (e) {
    menuInfo = {}; // default {}
  }

  for (const title in menuInfo) {
    if (menuInfo[title] && menuInfo[title].closed) { // menu in closed status.
      collapseMenu(title);
    } else {
      expandMenu(title);
    }
  }

  // highlight menu
  const pathname = window.location.pathname;
  const selector = `a[href="${pathname}"].menu-link,a[href="${pathname}index.html"].menu-link`;
  const menuItem = mobileAside.querySelector(selector);
  if (menuItem) { menuItem.className += ' highlight'; }
})();
</script>


  <div class="content">
    <div class="doc">
      <article class="markdown-body">
        <h1>TypeScript</h1>
          <blockquote>
<p><a href="https://www.typescriptlang.org/" target="_blank" rel="noopener">TypeScript</a> 是 JavaScript 类型的超集，它可以编译成纯 JavaScript。</p>
</blockquote>
<p>TypeScript 的静态类型检查，智能提示，IDE 友好性等特性，对于大规模企业级应用，是非常的有价值的。详见：<a href="https://juejin.im/post/59c46bc86fb9a00a4636f939" target="_blank" rel="noopener">TypeScript 体系调研报告</a> 。</p>
<p>然而，此前使用 TypeScript 开发 Egg ，会遇到一些影响 <strong>开发者体验</strong> 问题：</p>
<ul>
<li>Egg 最精髓的 Loader 自动加载机制，导致 TS 无法静态分析出部分依赖。</li>
<li>Config 自动合并机制下，如何在 <code>config.{env}.js</code> 里面修改插件提供的配置时，能校验并智能提示？</li>
<li>开发期需要独立开一个 <code>tsc -w</code> 独立进程来构建代码，带来临时文件位置纠结以及 <code>npm scripts</code> 复杂化。</li>
<li>单元测试，覆盖率测试，线上错误堆栈如何指向 TS 源文件，而不是编译后的 js 文件。</li>
</ul>
<p>本文主要阐述：</p>
<ul>
<li><strong>应用层 TS 开发规范</strong></li>
<li><strong>我们在工具链方面的支持，是如何来解决上述问题，让开发者几乎无感知并保持一致性。</strong></li>
</ul>
<p>具体的折腾过程参见：<a href="https://github.com/eggjs/egg/issues/2272" target="_blank" rel="noopener">[RFC] TypeScript tool support</a></p>
<hr>
<h2 id="快速入门"><a class="markdown-anchor" href="#快速入门">#</a> 快速入门</h2>
<p>通过骨架快速初始化：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mkdir showcase &amp;&amp; <span class="built_in">cd</span> showcase</span><br><span class="line">$ npm init egg --<span class="built_in">type</span>=ts</span><br><span class="line">$ npm i</span><br><span class="line">$ npm run dev</span><br></pre></td></tr></table></figure>
<p>上述骨架会生成一个极简版的示例，更完整的示例参见：<a href="https://github.com/eggjs/examples/tree/master/hackernews-async-ts" target="_blank" rel="noopener">eggjs/examples/hackernews-async-ts</a></p>
<p><img src="https://user-images.githubusercontent.com/227713/38358019-bf7890fa-38f6-11e8-8955-ea072ac6dc8c.gif" alt="tegg.gif"></p>
<hr>
<h2 id="目录规范"><a class="markdown-anchor" href="#目录规范">#</a> 目录规范</h2>
<p><strong>一些约束：</strong></p>
<ul>
<li>Egg 目前没有计划使用 TS 重写。</li>
<li>Egg 以及它对应的插件，会提供对应的 <code>index.d.ts</code> 文件方便开发者使用。</li>
<li>TypeScript 只是其中一种社区实践，我们通过工具链给予一定程度的支持。</li>
<li>TypeScript 最低要求：版本 2.8。</li>
</ul>
<p>整体目录结构上跟 Egg 普通项目没啥区别:</p>
<ul>
<li><code>typescript</code> 代码风格，后缀名为 <code>ts</code></li>
<li><code>typings</code> 目录用于放置 <code>d.ts</code> 文件（大部分会自动生成）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">showcase</span><br><span class="line">├── app</span><br><span class="line">│   ├── controller</span><br><span class="line">│   │   └── home.ts</span><br><span class="line">│   ├── service</span><br><span class="line">│   │   └── news.ts</span><br><span class="line">│   └── router.ts</span><br><span class="line">├── config</span><br><span class="line">│   ├── config.default.ts</span><br><span class="line">│   ├── config.local.ts</span><br><span class="line">│   ├── config.prod.ts</span><br><span class="line">│   └── plugin.ts</span><br><span class="line">├── <span class="built_in">test</span></span><br><span class="line">│   └── **/*.test.ts</span><br><span class="line">├── typings</span><br><span class="line">│   └── **/*.d.ts</span><br><span class="line">├── README.md</span><br><span class="line">├── package.json</span><br><span class="line">├── tsconfig.json</span><br><span class="line">└── tslint.json</span><br></pre></td></tr></table></figure>
<h3 id="控制器controller"><a class="markdown-anchor" href="#控制器controller">#</a> 控制器（Controller）</h3>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app/controller/home.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Controller &#125; <span class="keyword">from</span> <span class="string">'egg'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> HomeController <span class="keyword">extends</span> Controller &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">async</span> index() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, service &#125; = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">const</span> page = ctx.query.page;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> service.news.list(page);</span><br><span class="line">    <span class="keyword">await</span> ctx.render(<span class="string">'home.tpl'</span>, result);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="路由router"><a class="markdown-anchor" href="#路由router">#</a> 路由（Router）</h3>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app/router.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Application &#125; <span class="keyword">from</span> <span class="string">'egg'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (app: Application) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; router, controller &#125; = app;</span><br><span class="line">  router.get(<span class="string">'/'</span>, controller.home.index);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="服务service"><a class="markdown-anchor" href="#服务service">#</a> 服务（Service）</h3>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app/service/news.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Service &#125; <span class="keyword">from</span> <span class="string">'egg'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> NewsService <span class="keyword">extends</span> Service &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">async</span> list(page?: <span class="built_in">number</span>): <span class="built_in">Promise</span>&lt;NewsItem[]&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> [];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> NewsItem &#123;</span><br><span class="line">  id: <span class="built_in">number</span>;</span><br><span class="line">  title: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="中间件middleware"><a class="markdown-anchor" href="#中间件middleware">#</a> 中间件（Middleware）</h3>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Context &#125; <span class="keyword">from</span> <span class="string">'egg'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里是你自定义的中间件</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">fooMiddleware</span>(<span class="params"></span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> (ctx: Context, next: <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 你可以获取 config 的配置：</span></span><br><span class="line">    <span class="comment">// const config = ctx.app.config;</span></span><br><span class="line">    <span class="comment">// config.xxx....</span></span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当某个 Middleware 文件的名称与 config 中某个属性名一致时，Middleware 会自动把这个属性下的所有配置读取过来。</p>
<p>我们假定你有一个 Middleware，名称是 uuid，其 config.default.js 中配置如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; EggAppConfig, PowerPartial &#125; <span class="keyword">from</span> <span class="string">'egg'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>(<span class="params">appInfo: EggAppConfig</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> config = &#123;&#125; <span class="keyword">as</span> PowerPartial&lt;EggAppConfig&gt;;</span><br><span class="line"></span><br><span class="line">  config.keys = appInfo.name + <span class="string">'123123'</span>;</span><br><span class="line"></span><br><span class="line">  config.middleware = [<span class="string">'uuid'</span>];</span><br><span class="line"></span><br><span class="line">  config.security = &#123;</span><br><span class="line">    csrf: &#123;</span><br><span class="line">      ignore: <span class="string">'123'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> bizConfig = &#123;</span><br><span class="line">    local: &#123;</span><br><span class="line">      msg: <span class="string">'local'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    uuid: &#123;</span><br><span class="line">      name: <span class="string">'ebuuid'</span>,</span><br><span class="line">      maxAge: <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">365</span> * <span class="number">10</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ...config,</span><br><span class="line">    ...bizConfig,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在对应的 uuid 中间件中：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app/middleware/uuid.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Context, Application, EggAppConfig &#125; <span class="keyword">from</span> <span class="string">'egg'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">uuidMiddleWare</span>(<span class="params">options: EggAppConfig['uuid'], app: Application</span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> (ctx: Context, next: <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;) =&gt; &#123;</span><br><span class="line">    <span class="comment">// name 就是 config.default.js 中 uuid 下的属性</span></span><br><span class="line">    <span class="built_in">console</span>.info(options.name);</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意：Middleware 目前返回值必须都是 <code>any</code>，否则使用 route.get/all 等方法的时候因为 Koa 的 <code>IRouteContext</code> 和 Egg 自身的 <code>Context</code> 不兼容导致编译报错。</strong></p>
<h3 id="扩展extend"><a class="markdown-anchor" href="#扩展extend">#</a> 扩展（Extend）</h3>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app/extend/context.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Context &#125; <span class="keyword">from</span> <span class="string">'egg'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  isAjax(<span class="keyword">this</span>: Context) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.get(<span class="string">'X-Requested-With'</span>) === <span class="string">'XMLHttpRequest'</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// app.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> app =&gt; &#123;</span><br><span class="line">  app.beforeStart(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="built_in">Promise</span>.resolve(<span class="string">'egg + ts'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="配置config"><a class="markdown-anchor" href="#配置config">#</a> 配置（Config）</h3>
<p><code>Config</code> 这块稍微有点复杂，因为要支持：</p>
<ul>
<li>在 Controller，Service 那边使用配置，需支持多级提示，并自动关联。</li>
<li>Config 内部， <code>config.view = {}</code> 的写法，也应该支持提示。</li>
<li>在 <code>config.{env}.ts</code> 里可以用到 <code>config.default.ts</code> 自定义配置的提示。</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app/config/config.default.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; EggAppInfo, EggAppConfig, PowerPartial &#125; <span class="keyword">from</span> <span class="string">'egg'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (appInfo: EggAppInfo) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> config = &#123;&#125; <span class="keyword">as</span> PowerPartial&lt;EggAppConfig&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 覆盖框架，插件的配置</span></span><br><span class="line">  config.keys = appInfo.name + <span class="string">'123456'</span>;</span><br><span class="line">  config.view = &#123;</span><br><span class="line">    defaultViewEngine: <span class="string">'nunjucks'</span>,</span><br><span class="line">    mapping: &#123;</span><br><span class="line">      <span class="string">'.tpl'</span>: <span class="string">'nunjucks'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 应用本身的配置</span></span><br><span class="line">  <span class="keyword">const</span> bizConfig = &#123;&#125;;</span><br><span class="line">  bizConfig.news = &#123;</span><br><span class="line">    pageSize: <span class="number">30</span>,</span><br><span class="line">    serverUrl: <span class="string">'https://hacker-news.firebaseio.com/v0'</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 目的是将业务配置属性合并到 EggAppConfig 中返回</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="comment">// 如果直接返回 config ，将该类型合并到 EggAppConfig 的时候可能会出现 circulate type 错误。</span></span><br><span class="line">    ...config <span class="keyword">as</span> &#123;&#125;,</span><br><span class="line">    ...bizConfig,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>注意，上面这种写法，将 config.default.ts 中返回的配置类型合并到 egg 的 EggAppConfig 类型中需要 egg-ts-helper 的配合。</strong></p>
<p>当 EggAppConfig 合并 config.default.ts 的类型后，在其他 config.{env}.ts 中这么写就也可以获得在 config.default.ts 定义的自定义配置的智能提示：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app/config/config.local.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; EggAppConfig, &#125; <span class="keyword">from</span> <span class="string">'egg'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> config = &#123;&#125; <span class="keyword">as</span> PowerPartial&lt;EggAppConfig&gt;;</span><br><span class="line">  <span class="comment">// 这里就可以获得 news 的智能提示了</span></span><br><span class="line">  config.news = &#123;</span><br><span class="line">    pageSize: <span class="number">20</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> config;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>备注：</p>
<ul>
<li>TS 的 <code>Conditional Types</code> 是我们能完美解决 Config 提示的关键。</li>
<li>有兴趣的可以看下 <a href="https://github.com/eggjs/egg/blob/master/index.d.ts" target="_blank" rel="noopener">egg/index.d.ts</a> 里面的 <code>PowerPartial</code> 实现。</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// &#123;egg&#125;/index.d.ts</span></span><br><span class="line"><span class="keyword">type</span> PowerPartial&lt;T&gt; = &#123;</span><br><span class="line">  [U <span class="keyword">in</span> keyof T]?: T[U] <span class="keyword">extends</span> &#123;&#125;</span><br><span class="line">    ? PowerPartial&lt;T[U]&gt;</span><br><span class="line">    : T[U]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="插件plugin"><a class="markdown-anchor" href="#插件plugin">#</a> 插件（Plugin）</h3>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// config/plugin.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; EggPlugin &#125; <span class="keyword">from</span> <span class="string">'egg'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> plugin: EggPlugin = &#123;</span><br><span class="line">  <span class="keyword">static</span>: <span class="literal">true</span>,</span><br><span class="line">  nunjucks: &#123;</span><br><span class="line">    enable: <span class="literal">true</span>,</span><br><span class="line">    package: <span class="string">'egg-view-nunjucks'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> plugin;</span><br></pre></td></tr></table></figure>
<h3 id="生命周期lifecycle"><a class="markdown-anchor" href="#生命周期lifecycle">#</a> 生命周期（Lifecycle）</h3>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Application, IBoot &#125; <span class="keyword">from</span> <span class="string">'egg'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> FooBoot <span class="keyword">implements</span> IBoot &#123;</span><br><span class="line">  <span class="keyword">private</span> readonly app: Application;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params">app: Application</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.app = app;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  configWillLoad() &#123;</span><br><span class="line">    <span class="comment">// Ready to call configDidLoad,</span></span><br><span class="line">    <span class="comment">// Config, plugin files are referred,</span></span><br><span class="line">    <span class="comment">// this is the last chance to modify the config.</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  configDidLoad() &#123;</span><br><span class="line">    <span class="comment">// Config, plugin files have loaded.</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> didLoad() &#123;</span><br><span class="line">    <span class="comment">// All files have loaded, start plugin here.</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> willReady() &#123;</span><br><span class="line">    <span class="comment">// All plugins have started, can do some thing before app ready.</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> didReady() &#123;</span><br><span class="line">    <span class="comment">// Worker is ready, can do some things</span></span><br><span class="line">    <span class="comment">// don't need to block the app boot.</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> serverDidReady() &#123;</span><br><span class="line">    <span class="comment">// Server is listening.</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> beforeClose() &#123;</span><br><span class="line">    <span class="comment">// Do some thing before app close.</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ts-类型定义typings"><a class="markdown-anchor" href="#ts-类型定义typings">#</a> TS 类型定义（Typings）</h3>
<p>该目录为 TS 的规范，在里面的 <code>**/*.d.ts</code> 文件将被自动识别。</p>
<ul>
<li>开发者需要手写的建议放在 <code>typings/index.d.ts</code> 中。</li>
<li>工具会自动生成 <code>typings/{app,config}/**.d.ts</code> ，请勿自行修改，避免被覆盖。（见下文）</li>
</ul>
<hr>
<h2 id="开发期"><a class="markdown-anchor" href="#开发期">#</a> 开发期</h2>
<h3 id="ts-node"><a class="markdown-anchor" href="#ts-node">#</a> ts-node</h3>
<p><code>egg-bin</code> 已经内建了 <a href="https://github.com/TypeStrong/ts-node" target="_blank" rel="noopener">ts-node</a> ，<code>egg loader</code> 在开发期会自动加载 <code>*.ts</code> 并内存编译。</p>
<p>目前已支持 <code>dev</code> / <code>debug</code> / <code>test</code> / <code>cov</code> 。</p>
<p>开发者仅需简单配置下 <code>package.json</code> ：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"showcase"</span>,</span><br><span class="line">  <span class="attr">"egg"</span>: &#123;</span><br><span class="line">    <span class="attr">"typescript"</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="egg-ts-helper"><a class="markdown-anchor" href="#egg-ts-helper">#</a> egg-ts-helper</h3>
<p>由于 Egg 的自动加载机制，导致 TS 无法静态分析依赖，关联提示。</p>
<p>幸亏 TS 黑魔法比较多，我们可以通过 TS 的 <a href="https://www.typescriptlang.org/docs/handbook/declaration-merging.html" target="_blank" rel="noopener">Declaration Merging</a> 编写 <code>d.ts</code> 来辅助。</p>
<p>譬如 <code>app/service/news.ts</code> 会自动挂载为 <code>ctx.service.news</code> ，通过如下写法即识别到：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// typings/app/service/index.d.ts</span></span><br><span class="line"><span class="keyword">import</span> News <span class="keyword">from</span> <span class="string">'../../../app/service/News'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">module</span> 'egg' &#123;</span><br><span class="line">  <span class="keyword">interface</span> IService &#123;</span><br><span class="line">    news: News;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>手动写这些文件，未免有点繁琐，因此我们提供了 <a href="https://github.com/whxaxes/egg-ts-helper" target="_blank" rel="noopener">egg-ts-helper</a> 工具来自动分析源码生成对应的 <code>d.ts</code> 文件。</p>
<p>只需配置下 <code>package.json</code> :</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"egg"</span>: &#123;</span><br><span class="line">    <span class="attr">"declarations"</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"dev"</span>: <span class="string">"egg-bin dev"</span>,</span><br><span class="line">    <span class="attr">"test-local"</span>: <span class="string">"egg-bin test"</span>,</span><br><span class="line">    <span class="attr">"clean"</span>: <span class="string">"ets clean"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>开发期将自动生成对应的 <code>d.ts</code> 到 <code>typings/{app,config}/</code> 下，<strong>请勿自行修改，避免被覆盖</strong>。</p>
<p>目前该工具已经能支持 ts 以及 js 的 egg 项目，均能获得相应的智能提示。</p>
<h3 id="单元测试和覆盖率unit-test-and-cov"><a class="markdown-anchor" href="#单元测试和覆盖率unit-test-and-cov">#</a> 单元测试和覆盖率（Unit Test and Cov）</h3>
<p>单元测试当然少不了：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// test/app/service/news.test.ts</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> assert <span class="keyword">from</span> <span class="string">'assert'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Context &#125; <span class="keyword">from</span> <span class="string">'egg'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; app &#125; <span class="keyword">from</span> <span class="string">'egg-mock/bootstrap'</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'test/app/service/news.test.js'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> ctx: Context;</span><br><span class="line"></span><br><span class="line">  before(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    ctx = app.mockContext();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'list()'</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> list = <span class="keyword">await</span> ctx.service.news.list();</span><br><span class="line">    assert(list.length === <span class="number">30</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>运行命令也跟之前一样，并内置了 <code>错误堆栈和覆盖率</code> 的支持：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"showcase"</span>,</span><br><span class="line">  <span class="attr">"egg"</span>: &#123;</span><br><span class="line">    <span class="attr">"declarations"</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"test"</span>: <span class="string">"npm run lint -- --fix &amp;&amp; npm run test-local"</span>,</span><br><span class="line">    <span class="attr">"test-local"</span>: <span class="string">"egg-bin test"</span>,</span><br><span class="line">    <span class="attr">"cov"</span>: <span class="string">"egg-bin cov"</span>,</span><br><span class="line">    <span class="attr">"lint"</span>: <span class="string">"tslint ."</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="调试debug"><a class="markdown-anchor" href="#调试debug">#</a> 调试（Debug）</h3>
<p>断点调试跟之前也没啥区别，会自动通过 <code>sourcemap</code> 断点到正确的位置。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"showcase"</span>,</span><br><span class="line">  <span class="attr">"egg"</span>: &#123;</span><br><span class="line">    <span class="attr">"declarations"</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"debug"</span>: <span class="string">"egg-bin debug"</span>,</span><br><span class="line">    <span class="attr">"debug-test"</span>: <span class="string">"npm run test-local"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><a href="https://eggjs.org/zh-cn/core/development.html#%E4%BD%BF%E7%94%A8-vscode-%E8%BF%9B%E8%A1%8C%E8%B0%83%E8%AF%95">使用 VSCode 进行调试</a></li>
<li><a href="https://github.com/atian25/blog/issues/25" target="_blank" rel="noopener">VSCode 调试 Egg 完美版 - 进化史</a></li>
</ul>
<hr>
<h2 id="部署deploy"><a class="markdown-anchor" href="#部署deploy">#</a> 部署（Deploy）</h2>
<h3 id="构建build"><a class="markdown-anchor" href="#构建build">#</a> 构建（Build）</h3>
<ul>
<li>正式环境下，我们更倾向于把 ts 构建为 js ，建议在 <code>ci</code> 上构建并打包。</li>
</ul>
<p>配置 <code>package.json</code> :</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"egg"</span>: &#123;</span><br><span class="line">    <span class="attr">"typescript"</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"start"</span>: <span class="string">"egg-scripts start --title=egg-server-showcase"</span>,</span><br><span class="line">    <span class="attr">"stop"</span>: <span class="string">"egg-scripts stop --title=egg-server-showcase"</span>,</span><br><span class="line">    <span class="attr">"tsc"</span>: <span class="string">"ets &amp;&amp; tsc -p tsconfig.json"</span>,</span><br><span class="line">    <span class="attr">"ci"</span>: <span class="string">"npm run lint &amp;&amp; npm run cov &amp;&amp; npm run tsc"</span>,</span><br><span class="line">    <span class="attr">"clean"</span>: <span class="string">"ets clean"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应的 <code>tsconfig.json</code> :</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"compileOnSave"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"compilerOptions"</span>: &#123;</span><br><span class="line">    <span class="attr">"target"</span>: <span class="string">"es2017"</span>,</span><br><span class="line">    <span class="attr">"module"</span>: <span class="string">"commonjs"</span>,</span><br><span class="line">    <span class="attr">"strict"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"noImplicitAny"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"experimentalDecorators"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"emitDecoratorMetadata"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"charset"</span>: <span class="string">"utf8"</span>,</span><br><span class="line">    <span class="attr">"allowJs"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"pretty"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"noEmitOnError"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"noUnusedLocals"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"noUnusedParameters"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"allowUnreachableCode"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"allowUnusedLabels"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"strictPropertyInitialization"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"noFallthroughCasesInSwitch"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"skipLibCheck"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"skipDefaultLibCheck"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"inlineSourceMap"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"importHelpers"</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"exclude"</span>: [</span><br><span class="line">    <span class="string">"app/public"</span>,</span><br><span class="line">    <span class="string">"app/web"</span>,</span><br><span class="line">    <span class="string">"app/views"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意：当有同名的 ts 和 js 文件时，egg 会优先加载 js 文件。因此在开发期，<code>egg-ts-helper</code> 会自动调用清除同名的 <code>js</code> 文件，也可 <code>npm run clean</code> 手动清除。</strong></p>
<h3 id="错误堆栈error-stack"><a class="markdown-anchor" href="#错误堆栈error-stack">#</a> 错误堆栈（Error Stack）</h3>
<p>线上服务的代码是经过编译后的 js，而我们期望看到的错误堆栈是指向 TS 源码。
因此：</p>
<ul>
<li>在构建的时候，需配置 <code>inlineSourceMap: true</code> 在 js 底部插入 sourcemap 信息。</li>
<li>在 <code>egg-scripts</code> 内建了处理，会自动纠正为正确的错误堆栈，应用开发者无需担心。</li>
</ul>
<p>具体内幕参见：</p>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/26267678" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/26267678</a></li>
<li><a href="https://github.com/eggjs/egg-scripts/pull/19" target="_blank" rel="noopener">https://github.com/eggjs/egg-scripts/pull/19</a></li>
</ul>
<hr>
<h2 id="插件-框架开发指南"><a class="markdown-anchor" href="#插件-框架开发指南">#</a> 插件 / 框架开发指南</h2>
<p><strong>指导原则：</strong></p>
<ul>
<li>不建议使用 TS 直接开发插件/框架，发布到 npm 的插件应该是 js 形式。</li>
<li>当你开发了一个插件/框架后，需要提供对应的 <code>index.d.ts</code> 。</li>
<li>通过 <a href="https://www.typescriptlang.org/docs/handbook/declaration-merging.html" target="_blank" rel="noopener">Declaration Merging</a> 将插件/框架的功能注入到 Egg 中。</li>
<li>都挂载到 <code>egg</code> 这个 module，不要用上层框架。</li>
</ul>
<h3 id="插件"><a class="markdown-anchor" href="#插件">#</a> 插件</h3>
<p>可以参考 <code>egg-ts-helper</code> 自动生成的格式</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// &#123;plugin_root&#125;/index.d.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'egg'</span>;</span><br><span class="line"><span class="keyword">import</span> News <span class="keyword">from</span> <span class="string">'../../../app/service/News'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">module</span> 'egg' &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 扩展 service</span></span><br><span class="line">  <span class="keyword">interface</span> IService &#123;</span><br><span class="line">    news: News;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 扩展 app</span></span><br><span class="line">  <span class="keyword">interface</span> Application &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 扩展 context</span></span><br><span class="line">  <span class="keyword">interface</span> Context &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 扩展你的配置</span></span><br><span class="line">  <span class="keyword">interface</span> EggAppConfig &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 扩展自定义环境</span></span><br><span class="line">  <span class="keyword">type</span> EggEnvType = <span class="string">'local'</span> | <span class="string">'unittest'</span> | <span class="string">'prod'</span> | <span class="string">'sit'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="上层框架"><a class="markdown-anchor" href="#上层框架">#</a> 上层框架</h3>
<p>定义：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// &#123;framework_root&#125;/index.d.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> Egg <span class="keyword">from</span> <span class="string">'egg'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将该上层框架用到的插件 import 进来</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'my-plugin'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">module</span> 'egg' &#123;</span><br><span class="line">  <span class="comment">// 跟插件一样拓展 egg ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 Egg 整个 export 出去</span></span><br><span class="line"><span class="keyword">export</span> = Egg;</span><br></pre></td></tr></table></figure>
<p>开发者使用的时候，可以直接 import 你的框架：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app/service/news.ts</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 开发者引入你的框架，也可以使用到提示到所有 Egg 的提示</span></span><br><span class="line"><span class="keyword">import</span> &#123; Service &#125; <span class="keyword">from</span> <span class="string">'duck-egg'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> NewsService <span class="keyword">extends</span> Service &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">async</span> list(page?: <span class="built_in">number</span>): <span class="built_in">Promise</span>&lt;NewsItem[]&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> [];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="常见问题"><a class="markdown-anchor" href="#常见问题">#</a> 常见问题</h2>
<p>汇集一些有不少人提过的 issue 问题并统一解答。</p>
<h3 id="运行-npm-start-不会加载-ts"><a class="markdown-anchor" href="#运行-npm-start-不会加载-ts">#</a> 运行 npm start 不会加载 ts</h3>
<p>npm start 运行的是 <code>egg-scripts start</code>，而我们只在 egg-bin 中集成了 ts-node，也就是只有在使用 egg-bin 的时候才允许直接运行 ts 。</p>
<p>egg-scripts 是用于在生产环境下运行 egg 的 cli ，在生产环境下我们建议将 ts 编译成 js 之后再运行，毕竟在线上是需要考虑应用的健壮性和性能的，因此不建议在线上环境使用 ts-node 来运行应用。</p>
<p>而在开发期 ts-node 能降低 tsc 编译产生的文件带来的管理成本，并且 ts-node 带来的性能损耗在开发期几乎可以忽略，所以我们在 egg-bin 集成了 ts-node。</p>
<p><strong>总结：如果项目需要在线上运行，请先使用 tsc 将 ts 编译成 js （ <code>npm run tsc</code> ）再运行 <code>npm start</code>。</strong></p>
<h3 id="使用了-egg-插件后发现没有对应插件挂载的对象"><a class="markdown-anchor" href="#使用了-egg-插件后发现没有对应插件挂载的对象">#</a> 使用了 egg 插件后发现没有对应插件挂载的对象</h3>
<p>遇到该问题，一般是两种原因：</p>
<p><strong>1. 该 egg 插件未定义 d.ts 。</strong></p>
<p>如果要在插件中将某个对象挂载到 egg 的类型中，需要按照上面写的 <code>插件 / 框架开发指南</code> 补充声明文件到对应插件中。</p>
<p>如果需要上线想快速解决这个问题，可以直接在项目下新建个声明文件来解决。比如我使用了 <code>egg-dashboard</code> 这个插件，这个插件在 egg 的 app 中挂载了个 dashboard 对象，但是这个插件没有声明，直接使用 <code>app.dashboard</code> 又会有类型错误，我又急着解决该问题，就可以在项目下的 typings 目录下新建个 <code>index.d.ts</code> ，并且写入以下内容</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// typings/index.d.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'egg'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">module</span> 'egg' &#123;</span><br><span class="line">  <span class="keyword">interface</span> Application &#123;</span><br><span class="line">    dashboard: <span class="built_in">any</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>即可解决，当然，我们更期望你能给缺少声明的插件提 PR 补声明，方便你我他。</p>
<p><strong>2. egg 插件定义了 d.ts ，但是没有引入。</strong></p>
<p>如果 egg 插件中正确无误定义了 d.ts ，也需要在应用或者框架层显式 import 之后 ts 才能加载到对应类型。</p>
<p>如果使用了 egg-ts-helper ，egg-ts-helper 会自动根据应用中开启了什么插件从而生成显式 import 插件的声明。如果未使用，就需要开发者自行在 <code>d.ts</code> 中显式 import 对应插件。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// typings/index.d.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'egg-dashboard'</span>;</span><br></pre></td></tr></table></figure>
<p><strong>注意：必须在 d.ts 中 import，因为 egg 插件大部分没有入口文件，如果在 ts 中 import 的话运行会出问题。</strong></p>
<h3 id="在-tsconfigjson-中配置了-paths-无效"><a class="markdown-anchor" href="#在-tsconfigjson-中配置了-paths-无效">#</a> 在 tsconfig.json 中配置了 paths 无效</h3>
<p>这个严格来说不属于 egg 的问题，但是问的人不少，因此也在此解答一下。原因是 tsc 将 ts 编译成 js 的时候，并不会去转换 import 的模块路径，因此当你在 tsconfig.json 中配置了 paths 之后，如果你在 ts 中使用 paths 并 import 了对应模块，编译成 js 的时候就有大概率出现模块找不到的情况了。</p>
<p>解决办法是，要么不用 paths ，要么使用 paths 的时候只用来 import 一些声明而非具体值，再要么就可以使用 <a href="https://github.com/dividab/tsconfig-paths" target="_blank" rel="noopener">tsconfig-paths</a> 来 hook 掉 node 中的模块路径解析逻辑，从而支持 tsconfig.json 中的 paths。</p>
<p>使用 tsconfig-paths 可以直接在 config/plugin.ts 中引入，因为 plugin.ts 不管在 App 中还是在 Agent 中都是第一个加载的，因此在这个代码中引入 tsconfig-paths 即可。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// config/plugin.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'tsconfig-paths/register'</span>;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="给-egg-插件提交声明的时候如何编写单测"><a class="markdown-anchor" href="#给-egg-插件提交声明的时候如何编写单测">#</a> 给 egg 插件提交声明的时候如何编写单测？</h3>
<p>由于有不少开发者在给 egg 插件提交声明的时候，不知道如何编写单测来测试声明的准确性，因此也在这里说明一下。</p>
<p>当给一个 egg 插件编写好声明之后，就可以在 <code>test/fixures</code> 下创建个使用 ts 写的 egg 应用，参考 （ https://github.com/eggjs/egg-view/tree/master/test/fixtures/apps/ts ），记得在 tsconfig.json 中加入 paths 的配置从而方便在 fixture 中 import ，比如 egg-view 中的</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">"paths": &#123;</span><br><span class="line">  "egg-view": ["../../../../"]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时记住不要在 tsconfig.json 中配置 <code>&quot;skipLibCheck&quot;: true</code> ，如果配置了该属性为 true ，tsc 编译的时候会忽略 d.ts 中的类型校验，这样单测就无意义了。</p>
<p>然后再添加一个用例用来验证插件的声明使用是否正确即可，还是拿 egg-view 来做示例。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">describe(<span class="string">'typescript'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'should compile ts without error'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> coffee.fork(</span><br><span class="line">      <span class="built_in">require</span>.resolve(<span class="string">'typescript/bin/tsc'</span>),</span><br><span class="line">      [ <span class="string">'-p'</span>, path.resolve(__dirname, <span class="string">'./fixtures/apps/ts/tsconfig.json'</span>) ]</span><br><span class="line">    )</span><br><span class="line">      <span class="comment">// .debug()</span></span><br><span class="line">      .expect(<span class="string">'code'</span>, <span class="number">0</span>)</span><br><span class="line">      .end();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>可参考单测的项目：</p>
<ul>
<li><a href="https://github.com/eggjs/egg" target="_blank" rel="noopener">https://github.com/eggjs/egg</a></li>
<li><a href="https://github.com/eggjs/egg-view" target="_blank" rel="noopener">https://github.com/eggjs/egg-view</a></li>
<li><a href="https://github.com/eggjs/egg-logger" target="_blank" rel="noopener">https://github.com/eggjs/egg-logger</a></li>
</ul>
    
        </article>  
      </div>      
  </div>

  <div class="toc" id="toc">
  <ol class="toc-detail"><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#快速入门"><span class="toc-detail-number">1.</span> <span class="toc-detail-text"># 快速入门</span></a></li><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#目录规范"><span class="toc-detail-number">2.</span> <span class="toc-detail-text"># 目录规范</span></a><ol class="toc-detail-child"><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#控制器controller"><span class="toc-detail-number">2.1.</span> <span class="toc-detail-text"># 控制器（Controller）</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#路由router"><span class="toc-detail-number">2.2.</span> <span class="toc-detail-text"># 路由（Router）</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#服务service"><span class="toc-detail-number">2.3.</span> <span class="toc-detail-text"># 服务（Service）</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#中间件middleware"><span class="toc-detail-number">2.4.</span> <span class="toc-detail-text"># 中间件（Middleware）</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#扩展extend"><span class="toc-detail-number">2.5.</span> <span class="toc-detail-text"># 扩展（Extend）</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#配置config"><span class="toc-detail-number">2.6.</span> <span class="toc-detail-text"># 配置（Config）</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#插件plugin"><span class="toc-detail-number">2.7.</span> <span class="toc-detail-text"># 插件（Plugin）</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#生命周期lifecycle"><span class="toc-detail-number">2.8.</span> <span class="toc-detail-text"># 生命周期（Lifecycle）</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#ts-类型定义typings"><span class="toc-detail-number">2.9.</span> <span class="toc-detail-text"># TS 类型定义（Typings）</span></a></li></ol></li><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#开发期"><span class="toc-detail-number">3.</span> <span class="toc-detail-text"># 开发期</span></a><ol class="toc-detail-child"><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#ts-node"><span class="toc-detail-number">3.1.</span> <span class="toc-detail-text"># ts-node</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#egg-ts-helper"><span class="toc-detail-number">3.2.</span> <span class="toc-detail-text"># egg-ts-helper</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#单元测试和覆盖率unit-test-and-cov"><span class="toc-detail-number">3.3.</span> <span class="toc-detail-text"># 单元测试和覆盖率（Unit Test and Cov）</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#调试debug"><span class="toc-detail-number">3.4.</span> <span class="toc-detail-text"># 调试（Debug）</span></a></li></ol></li><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#部署deploy"><span class="toc-detail-number">4.</span> <span class="toc-detail-text"># 部署（Deploy）</span></a><ol class="toc-detail-child"><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#构建build"><span class="toc-detail-number">4.1.</span> <span class="toc-detail-text"># 构建（Build）</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#错误堆栈error-stack"><span class="toc-detail-number">4.2.</span> <span class="toc-detail-text"># 错误堆栈（Error Stack）</span></a></li></ol></li><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#插件-框架开发指南"><span class="toc-detail-number">5.</span> <span class="toc-detail-text"># 插件 / 框架开发指南</span></a><ol class="toc-detail-child"><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#插件"><span class="toc-detail-number">5.1.</span> <span class="toc-detail-text"># 插件</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#上层框架"><span class="toc-detail-number">5.2.</span> <span class="toc-detail-text"># 上层框架</span></a></li></ol></li><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#常见问题"><span class="toc-detail-number">6.</span> <span class="toc-detail-text"># 常见问题</span></a><ol class="toc-detail-child"><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#运行-npm-start-不会加载-ts"><span class="toc-detail-number">6.1.</span> <span class="toc-detail-text"># 运行 npm start 不会加载 ts</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#使用了-egg-插件后发现没有对应插件挂载的对象"><span class="toc-detail-number">6.2.</span> <span class="toc-detail-text"># 使用了 egg 插件后发现没有对应插件挂载的对象</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#在-tsconfigjson-中配置了-paths-无效"><span class="toc-detail-number">6.3.</span> <span class="toc-detail-text"># 在 tsconfig.json 中配置了 paths 无效</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#给-egg-插件提交声明的时候如何编写单测"><span class="toc-detail-number">6.4.</span> <span class="toc-detail-text"># 给 egg 插件提交声明的时候如何编写单测？</span></a></li></ol></li></ol>
</div>

<script>

var tocContainer = document.getElementById('toc');
var tocDetail = document.getElementsByClassName('toc-detail')[0];

(function(){
  if(!tocDetail){
    tocContainer.style.display = 'none';
  }

  if(tocDetail){
    document.querySelectorAll('.toc-detail-text').forEach(function(element){
      element.innerText = element.innerText.replace('# ', '');
    });
  }
})();
</script>

</div>

  </div>
</body>
<script src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script>
<script>
docsearch({
  apiKey: '1561de31a86f79507ea00cdb54ce647c',
  indexName: 'eggjs',
  inputSelector: '#search-query',
});
</script>
<div class="cnzz">
<script src="https://s11.cnzz.com/z_stat.php?id=1261142226&web_id=1261142226" language="JavaScript"></script>
</div>

</html>
